import tensorflow as tf
import transformers as ts
from bert_score import score
from summarizer import TransformerSummarizer
import tweets

def initialize_models():
    model_name = 'facebook/bart-large-cnn'
    cache_dir = 'cache/'
    tokenizer = ts.AutoTokenizer.from_pretrained(model_name, cache_dir = cache_dir)
    model = ts.TFAutoModelForSeq2SeqLM.from_pretrained(model_name, cache_dir = cache_dir)
    bart_summarizer = ts.pipeline("summarization", model=model, tokenizer=tokenizer)
    gpt_summarizer = TransformerSummarizer(transformer_type="GPT2", transformer_model_key="gpt2-medium")
    xlnet_summarizer = TransformerSummarizer(transformer_type="XLNet", transformer_model_key="xlnet-base-cased")
    pegasus_summarizer = ts.pipeline("summarization", model = "google/pegasus-cnn_dailymail", max_length=100)
    return bart_summarizer, gpt_summarizer, xlnet_summarizer, pegasus_summarizer

def get_score(input_text, summary):
    _,_,f1 = score([summary], [input_text], lang='en', verbose=False)
    return f1.item()

def bart_analysis(bart_summarizer, input_text):
    summary = bart_summarizer(input_text, batch_size = 3, max_length = 100, min_length = 20, do_sample = False, num_beams = 4, max_time = 5, length_penalty = 4.0)[0]['summary_text']
    return summary

def gpt_analysis(gpt_summarizer, input_text):
    summary = ''.join(gpt_summarizer(input_text, min_length=20, max_length=100))
    return summary

def xlnet_analysis(xlnet_summarizer, input_text):
    summary = ''.join(xlnet_summarizer(input_text, min_length=20, max_length=100))
    return summary

def pegasus_analysis(pegasus_summarizer, input_text):
    pipe_out = pegasus_summarizer(input_text)
    return pipe_out[0]['summary_text']

def analyze():
    input_text = """
        Researchers have discovered a new species of dinosaur in Argentina, which they believe is 
        the oldest-known member of the titanosaur group. The dinosaur lived 140 million years ago 
        and measured about 20 feet long. It has been named Ninjatitan zapatai in honor of Argentine 
        paleontologist Sebastian Apesteguia, who is also known as "The Ninja".
        """

    bart_summarizer, gpt_summarizer, xlnet_summarizer, pegasus_summarizer = initialize_models()
    print("Models created")
    bart_summary = bart_analysis(bart_summarizer, input_text)
    bart_score = get_score(input_text, bart_summary)
    print("**************")
    print("Bart Summary: " + bart_summary)
    print("Bart Score: " + str(bart_score * 100))

    print("**************")
    gpt_summary = gpt_analysis(gpt_summarizer, input_text)
    gpt_score = get_score(input_text, gpt_summary)
    print("GPT Summary: " + gpt_summary)
    print("GPT Score: " + str(gpt_score * 100))

    print("**************")
    xlnet_summary = xlnet_analysis(xlnet_summarizer, input_text)
    xlnet_score = get_score(input_text, xlnet_summary)
    print("XLNet Summary: " + xlnet_summary)
    print("XLNet Score: " + str(xlnet_score * 100))

    print("**************")
    pegasus_summary = pegasus_analysis(pegasus_summarizer, input_text).replace(".<n>",". ")
    pegasus_score = get_score(input_text, pegasus_summary)
    print("Pegasus summary: " + pegasus_summary)
    print("Pegasus score: " + str(pegasus_score * 100))

def summarize_bart(keyword):
    model_name = 'facebook/bart-large-cnn'
    cache_dir = 'cache/'
    tokenizer = ts.AutoTokenizer.from_pretrained(model_name, cache_dir = cache_dir)
    model = ts.TFAutoModelForSeq2SeqLM.from_pretrained(model_name, cache_dir = cache_dir)
    bart_summarizer = ts.pipeline("summarization", model=model, tokenizer=tokenizer)
    tweets_data = tweets.get_tweets(keyword) 
    bart_summary = bart_analysis(bart_summarizer, tweets_data)
    bart_score = get_score(tweets_data, bart_summary)
    print(bart_score)
    return bart_summary

def summarize(keyword):
    print("You entered: " + keyword)
    input_text = """
        Researchers have discovered a new species of dinosaur in Argentina, which they believe is 
        the oldest-known member of the titanosaur group. The dinosaur lived 140 million years ago 
        and measured about 20 feet long. It has been named Ninjatitan zapatai in honor of Argentine 
        paleontologist Sebastian Apesteguia, who is also known as "The Ninja".
        """
    pegasus_summarizer = ts.pipeline("summarization", model = "google/pegasus-cnn_dailymail", max_length = 100)
    tweets_data = tweets.get_tweets(keyword) 
    print('Starting to summarize')
    pipe_out = pegasus_summarizer(tweets_data)
    summary = pipe_out[0]['summary_text'].replace(".<n>",". ")
    print('Summarization done')
    return summary

def classify(keyword):
    print("Method beginning")
    cache_dir = 'cache/'
    input_text = """
        Researchers have discovered a new species of dinosaur in Argentina, which they believe is 
        the oldest-known member of the titanosaur group. The dinosaur lived 140 million years ago 
        and measured about 20 feet long. It has been named Ninjatitan zapatai in honor of Argentine 
        paleontologist Sebastian Apesteguia, who is also known as "The Ninja".
        """
    classifier = ts.pipeline('zero-shot-classification', cache_dir=cache_dir)
    labels = ['politics', 'sports', 'science', 'finance', 'entertainment']
    tweets_data = tweets.get_tweets(keyword)
    print("Starting to classify")
    response = classifier(tweets_data, labels)
    print("Classification done")
    return response

def sentimentAnalysis(keyword):
    cache_dir = 'cache/'
    input_text = """
        Researchers have discovered a new species of dinosaur in Argentina, which they believe is 
        the oldest-known member of the titanosaur group. The dinosaur lived 140 million years ago 
        and measured about 20 feet long. It has been named Ninjatitan zapatai in honor of Argentine 
        paleontologist Sebastian Apesteguia, who is also known as "The Ninja".
        """
    classifier = ts.pipeline('zero-shot-classification', cache_dir=cache_dir)
    labels = ['positive', 'negative']
    tweets_data = tweets.get_tweets(keyword)
    response = classifier(tweets_data, labels)
    return response